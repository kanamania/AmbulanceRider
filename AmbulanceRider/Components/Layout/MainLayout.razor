@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager NavigationManager

<PageTitle>AmbulanceRider</PageTitle>

@if (isLoading)
{
    <div class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}

<div class="app @(isLoading ? "blur" : "")">
    <NavMenu />

    <div class="main-content">
        <div class="content-wrapper px-4 py-3">
            @if (hasError)
            {
                <div class="alert alert-danger">
                    <h5>An error occurred</h5>
                    <p>@errorMessage</p>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ReloadApp">
                        <i class="bi bi-arrow-clockwise"></i> Reload Application
                    </button>
                </div>
            }
            else
            {
                @Body
            }
        </div>
    </div>
</div>

<div id="blazor-error-ui" class="alert alert-danger" data-nosnippet style="display: none;">
    <div class="d-flex justify-content-between align-items-center">
        <span>An unhandled error has occurred. <span id="blazor-error-details" class="small"></span></span>
        <div>
            <button class="btn btn-sm btn-outline-light me-2" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> Reload
            </button>
            <button class="btn-close btn-close-white" onclick="document.getElementById('blazor-error-ui').style.display = 'none'"></button>
        </div>
    </div>
</div>

@code {
    private bool isLoading = true;
    private bool hasError = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // Simulate loading (remove in production)
            await Task.Delay(1000);
            isLoading = false;
            await base.OnInitializedAsync();
        }
        catch (Exception ex)
        {
            hasError = true;
            errorMessage = ex.Message;
            Console.Error.WriteLine($"Error in MainLayout: {ex}");
        }
    }

    private void ReloadApp()
    {
        NavigationManager.NavigateTo("/", forceLoad: true);
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}

<style>
    .app {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        transition: filter 0.3s ease-in-out;
    }

    .app.blur {
        filter: blur(2px);
        pointer-events: none;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #f8f9fa;
    }

    .content-wrapper {
        flex: 1;
        padding: 1.5rem;
        background-color: #fff;
        margin: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    #blazor-error-ui {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 2000;
        border-radius: 0;
        margin: 0;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Navbar customization */
    .navbar {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand {
        font-weight: 600;
        font-size: 1.25rem;
    }

    .dropdown-menu {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border: none;
    }

    .dropdown-item {
        padding: 0.5rem 1rem;
        transition: background-color 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: #f8f9fa;
    }

    .dropdown-item i {
        width: 1.25rem;
    }

    /* Multi-level dropdown support */
    .dropend .dropdown-menu {
        top: 0;
        left: 100%;
        margin-left: 0.125rem;
    }

    @@media (max-width: 991px) {
        .dropend .dropdown-menu {
            position: static;
            margin-left: 1rem;
            box-shadow: none;
            border-left: 2px solid #0d6efd;
        }
    }
</style>