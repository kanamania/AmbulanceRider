@page "/companies"
@using AmbulanceRider.Models
@using AmbulanceRider.Services
@using Microsoft.AspNetCore.WebUtilities
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin,Dispatcher")]

<PageTitle>Companies</PageTitle>

<div class="min-h-screen bg-slate-50 px-6 py-8">
    <div class="mx-auto flex max-w-6xl flex-col gap-6">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="flex items-center gap-2 text-2xl font-semibold text-slate-900">
                    <i class="bi bi-buildings"></i>
                    Companies
                </h1>
                <p class="text-sm text-slate-600">Manage organizations, contacts, and addresses.</p>
            </div>
            <button class="inline-flex items-center gap-2 rounded-full bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" @onclick="NavigateToCreate">
                <i class="bi bi-plus-circle"></i>
                Add Company
            </button>
        </div>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="flex items-start gap-3 rounded-xl border border-emerald-200 bg-emerald-50 px-5 py-4 text-emerald-700">
                <i class="bi bi-check-circle-fill text-xl"></i>
                <div>
                    <p class="text-sm font-medium">@successMessage</p>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="flex items-start gap-3 rounded-xl border border-red-200 bg-red-50 px-5 py-4 text-red-700">
                <i class="bi bi-exclamation-triangle-fill text-xl"></i>
                <div>
                    <p class="text-sm font-medium">@errorMessage</p>
                </div>
            </div>
        }

        @if (isLoading)
        {
            <div class="flex justify-center py-16">
                <span class="h-12 w-12 animate-spin rounded-full border-4 border-blue-100 border-t-blue-600"></span>
            </div>
        }
        else if (companies.Count == 0)
        {
            <div class="rounded-2xl border border-dashed border-slate-200 bg-white px-8 py-12 text-center shadow-sm">
                <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-50 text-blue-600">
                    <i class="bi bi-buildings"></i>
                </div>
                <h2 classicon="mt-4 text-lg font-semibold text-slate-900">No companies yet</h2>
                <p class="mt-2 text-sm text-slate-600">Get started by creating your first company profile.</p>
                <button class="mt-6 inline-flex items-center gap-2 rounded-full bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" @onclick="NavigateToCreate">
                    <i class="bi bi-plus-circle"></i>
                    Create Company
                </button>
            </div>
        }
        else
        {
            <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 text-sm">
                        <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-600">
                            <tr>
                                <th scope="col" class="px-6 py-3">Name</th>
                                <th scope="col" class="px-6 py-3">Description</th>
                                <th scope="col" class="px-6 py-3">Contact Email</th>
                                <th scope="col" class="px-6 py-3">Phone</th>
                                <th scope="col" class="px-6 py-3">Address</th>
                                <th scope="col" class="px-6 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-slate-700">
                            @foreach (var company in companies)
                            {
                                <tr class="transition hover:bg-slate-50">
                                    <td class="px-6 py-4 font-semibold text-slate-900">@company.Name</td>
                                    <td class="px-6 py-4 text-slate-600">@company.Description</td>
                                    <td class="px-6 py-4 text-slate-600">@company.ContactEmail</td>
                                    <td class="px-6 py-4 text-slate-600">@company.ContactPhone</td>
                                    <td class="px-6 py-4 text-slate-600">@company.Address</td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center justify-end gap-2">
                                            <button class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-500 transition hover:border-blue-200 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" title="Edit" @onclick="() => NavigateToEdit(company.Id)">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-red-200 bg-white text-red-500 transition hover:border-red-300 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60" title="Delete" @onclick="() => ConfirmDelete(company.Id)" disabled="@deletingCompanyIds.Contains(company.Id)">
                                                @if (deletingCompanyIds.Contains(company.Id))
                                                {
                                                    <span class="h-4 w-4 animate-spin rounded-full border-2 border-red-200 border-t-red-500"></span>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-trash"></i>
                                                }
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private List<CompanyDto> companies = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string? successMessage;
    private readonly HashSet<int> deletingCompanyIds = new();

    protected override async Task OnInitializedAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("status", out var status))
        {
            successMessage = status.ToString() switch
            {
                "created" => "Company created successfully.",
                "updated" => "Company updated successfully.",
                _ => successMessage
            };

            if (!string.IsNullOrEmpty(successMessage))
            {
                Navigation.NavigateTo("/companies", replace: true);
            }
        }

        await LoadCompanies(!string.IsNullOrEmpty(successMessage));
    }

    private async Task LoadCompanies(bool preserveSuccessMessage = false)
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            if (!preserveSuccessMessage)
            {
                successMessage = null;
            }
            companies = await ApiService.GetCompaniesAsync() ?? new List<CompanyDto>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load companies: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/companies/create");
    }

    private void NavigateToEdit(int id)
    {
        Navigation.NavigateTo($"/companies/edit/{id}");
    }

    private async Task ConfirmDelete(int id)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this company?");
        if (!confirm)
        {
            return;
        }

        await DeleteCompany(id);
    }

    private async Task DeleteCompany(int id)
    {
        if (deletingCompanyIds.Contains(id))
        {
            return;
        }

        deletingCompanyIds.Add(id);
        StateHasChanged();

        try
        {
            errorMessage = null;
            successMessage = null;
            await ApiService.DeleteCompanyAsync(id);
            successMessage = "Company deleted successfully.";
            await LoadCompanies(true);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete company: {ex.Message}";
        }
        finally
        {
            deletingCompanyIds.Remove(id);
            StateHasChanged();
        }
    }
}
