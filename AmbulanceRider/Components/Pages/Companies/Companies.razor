@page "/companies"
@using AmbulanceRider.Models
@using AmbulanceRider.Services
@using Microsoft.AspNetCore.WebUtilities
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin,Dispatcher")]

<PageTitle>Companies</PageTitle>

<div class="px-6 py-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900 flex items-center gap-2">
                <i class="bi bi-buildings"></i>
                Companies
            </h1>
            <p class="text-sm text-gray-600">Manage organizations and view contact information.</p>
        </div>
        <button class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus-visible:ring focus-visible:ring-blue-500/70" @onclick="NavigateToCreate">
            <i class="bi bi-plus-circle"></i>
            New Company
        </button>
    </div>

    @if (isLoading)
    {
        <div class="flex justify-center py-16">
            <div class="h-10 w-10 animate-spin rounded-full border-4 border-blue-200 border-t-blue-600"></div>
        </div>
    }
    else if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-green-700 flex items-start gap-3 mb-6">
            <i class="bi bi-check-circle text-xl"></i>
            <span>@successMessage</span>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-red-700 flex items-start gap-3">
            <i class="bi bi-exclamation-triangle text-xl"></i>
            <span>@errorMessage</span>
        </div>
    }
    else if (companies.Count == 0)
    {
        <div class="rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 text-blue-700 flex items-start gap-3">
            <i class="bi bi-info-circle text-xl"></i>
            <div>
                <p class="font-medium">No companies found.</p>
                <p class="text-sm">Click "New Company" to register an organization.</p>
            </div>
        </div>
    }
    else
    {
        <div class="overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm">
            <table class="w-full table-auto">
                <thead class="bg-gray-50">
                    <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-600">
                        <th class="px-6 py-3">Name</th>
                        <th class="px-6 py-3">Description</th>
                        <th class="px-6 py-3">Contact Email</th>
                        <th class="px-6 py-3">Contact Phone</th>
                        <th class="px-6 py-3">Address</th>
                        <th class="px-6 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 text-sm text-gray-700">
                    @foreach (var company in companies)
                    {
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium">@company.Name</td>
                            <td class="px-6 py-4">@company.Description</td>
                            <td class="px-6 py-4">@company.ContactEmail</td>
                            <td class="px-6 py-4">@company.ContactPhone</td>
                            <td class="px-6 py-4">@company.Address</td>
                            <td class="px-6 py-4">
                                <div class="flex justify-end gap-2">
                                    <button class="inline-flex items-center gap-1 rounded-lg border border-gray-200 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus-visible:ring focus-visible:ring-gray-500/40" @onclick="() => NavigateToEdit(company.Id)">
                                        <i class="bi bi-pencil"></i>
                                        Edit
                                    </button>
                                    <button class="inline-flex items-center gap-1 rounded-lg border border-red-200 px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50 focus:outline-none focus-visible:ring focus-visible:ring-red-500/40 disabled:opacity-50 disabled:cursor-not-allowed" @onclick="() => ConfirmDelete(company.Id)" disabled="@deletingCompanyIds.Contains(company.Id)">
                                        @if (deletingCompanyIds.Contains(company.Id))
                                        {
                                            <span class="inline-flex items-center gap-1">
                                                <span class="h-4 w-4 animate-spin rounded-full border-2 border-red-200 border-t-red-600"></span>
                                                Deleting
                                            </span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-trash"></i>
                                            <span>Delete</span>
                                        }
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<CompanyDto> companies = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string? successMessage;
    private readonly HashSet<int> deletingCompanyIds = new();

    protected override async Task OnInitializedAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("status", out var status))
        {
            successMessage = status.ToString() switch
            {
                "created" => "Company created successfully.",
                "updated" => "Company updated successfully.",
                _ => successMessage
            };

            if (!string.IsNullOrEmpty(successMessage))
            {
                Navigation.NavigateTo("/companies", replace: true);
            }
        }

        await LoadCompanies(!string.IsNullOrEmpty(successMessage));
    }

    private async Task LoadCompanies(bool preserveSuccessMessage = false)
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            if (!preserveSuccessMessage)
            {
                successMessage = null;
            }
            companies = await ApiService.GetCompaniesAsync() ?? new List<CompanyDto>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load companies: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/companies/create");
    }

    private void NavigateToEdit(int id)
    {
        Navigation.NavigateTo($"/companies/edit/{id}");
    }

    private async Task ConfirmDelete(int id)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this company?");
        if (!confirm)
        {
            return;
        }

        await DeleteCompany(id);
    }

    private async Task DeleteCompany(int id)
    {
        if (deletingCompanyIds.Contains(id))
        {
            return;
        }

        deletingCompanyIds.Add(id);
        StateHasChanged();

        try
        {
            errorMessage = null;
            successMessage = null;
            await ApiService.DeleteCompanyAsync(id);
            successMessage = "Company deleted successfully.";
            await LoadCompanies(true);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete company: {ex.Message}";
        }
        finally
        {
            deletingCompanyIds.Remove(id);
            StateHasChanged();
        }
    }
}
