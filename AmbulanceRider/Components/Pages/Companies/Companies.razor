@page "/companies"
@using AmbulanceRider.Models
@using AmbulanceRider.Services
@using Microsoft.AspNetCore.WebUtilities
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin,Dispatcher")]

<PageTitle>Companies</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="flex items-center gap-2 text-2xl font-semibold text-slate-900">
            <i class="bi bi-buildings"></i>
            Companies
        </h1>
        <p class="text-sm text-slate-600">Manage organizations, contacts, and addresses.</p>
        <button class="btn btn-primary create-btn" @onclick="NavigateToCreate">
            <i class="bi bi-plus-circle me-1"></i> Add New Company
        </button>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>@errorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (companies.Count == 0)
    {
        <div class="rounded-2xl border border-dashed border-slate-200 bg-white px-8 py-12 text-center shadow-sm">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-50 text-blue-600">
                <i class="bi bi-buildings"></i>
            </div>
            <h2 classicon="mt-4 text-lg font-semibold text-slate-900">No companies yet</h2>
            <p class="mt-2 text-sm text-slate-600">Get started by creating your first company profile.</p>
            <button
                class="mt-6 inline-flex items-center gap-2 rounded-full bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                @onclick="NavigateToCreate">
                <i class="bi bi-plus-circle"></i>
                Create Company
            </button>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-600">
                        <tr>
                            <th scope="col" class="px-6 py-3">Name</th>
                            <th scope="col" class="px-6 py-3">Description</th>
                            <th scope="col" class="px-6 py-3">Contact Email</th>
                            <th scope="col" class="px-6 py-3">Phone</th>
                            <th scope="col" class="px-6 py-3">Address</th>
                            <th scope="col" class="px-6 py-3 text-right">Actions</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-slate-700">
                        @foreach (var company in companies)
                        {
                            <tr class="transition hover:bg-slate-50">
                                <td class="px-6 py-4 font-semibold text-slate-900">@company.Name</td>
                                <td class="px-6 py-4 text-slate-600">@company.Description</td>
                                <td class="px-6 py-4 text-slate-600">@company.ContactEmail</td>
                                <td class="px-6 py-4 text-slate-600">@company.ContactPhone</td>
                                <td class="px-6 py-4 text-slate-600">@company.Address</td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center justify-end gap-2">
                                        <button
                                            class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-500 transition hover:border-blue-200 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                            title="Edit" @onclick="() => NavigateToEdit(company.Id)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button
                                            class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-red-200 bg-white text-red-500 transition hover:border-red-300 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                                            title="Delete" @onclick="() => ConfirmDelete(company.Id)"
                                            disabled="@deletingCompanyIds.Contains(company.Id)">
                                            @if (deletingCompanyIds.Contains(company.Id))
                                            {
                                                <span
                                                    class="h-4 w-4 animate-spin rounded-full border-2 border-red-200 border-t-red-500"></span>
                                            }
                                            else
                                            {
                                                <i class="bi bi-trash"></i>
                                            }
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<CompanyDto> companies = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string? successMessage;
    private readonly HashSet<int> deletingCompanyIds = new();

    protected override async Task OnInitializedAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("status", out var status))
        {
            successMessage = status.ToString() switch
            {
                "created" => "Company created successfully.",
                "updated" => "Company updated successfully.",
                _ => successMessage
            };

            if (!string.IsNullOrEmpty(successMessage))
            {
                Navigation.NavigateTo("/companies", replace: true);
            }
        }

        await LoadCompanies(!string.IsNullOrEmpty(successMessage));
    }

    private async Task LoadCompanies(bool preserveSuccessMessage = false)
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            if (!preserveSuccessMessage)
            {
                successMessage = null;
            }

            companies = await ApiService.GetCompaniesAsync() ?? new List<CompanyDto>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load companies: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/companies/create");
    }

    private void NavigateToEdit(int id)
    {
        Navigation.NavigateTo($"/companies/edit/{id}");
    }

    private async Task ConfirmDelete(int id)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this company?");
        if (!confirm)
        {
            return;
        }

        await DeleteCompany(id);
    }

    private async Task DeleteCompany(int id)
    {
        if (deletingCompanyIds.Contains(id))
        {
            return;
        }

        deletingCompanyIds.Add(id);
        StateHasChanged();

        try
        {
            errorMessage = null;
            successMessage = null;
            await ApiService.DeleteCompanyAsync(id);
            successMessage = "Company deleted successfully.";
            await LoadCompanies(true);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete company: {ex.Message}";
        }
        finally
        {
            deletingCompanyIds.Remove(id);
            StateHasChanged();
        }
    }

}
