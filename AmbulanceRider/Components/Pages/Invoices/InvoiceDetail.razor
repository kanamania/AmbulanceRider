@page "/invoices/{Id:int}"
@using AmbulanceRider.Models
@using AmbulanceRider.Services
@inject IApiService ApiService
@inject NavigationManager NavigationManager
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin,Dispatcher")]

<div class="container-fluid mt-4">
    @if (loading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (invoice != null)
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <button class="btn btn-outline-secondary" @onclick="GoBack">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
            <div class="btn-group">
                @if (invoice.Status != "Paid")
                {
                    <button class="btn btn-success" @onclick="MarkAsPaid">
                        <i class="bi bi-check-circle"></i> Mark as Paid
                    </button>
                }
                <button class="btn btn-danger" @onclick="DownloadPdf">
                    <i class="bi bi-file-pdf"></i> Download PDF
                </button>
                <button class="btn btn-success" @onclick="DownloadExcel">
                    <i class="bi bi-file-excel"></i> Download Excel
                </button>
                <button class="btn btn-info" @onclick="DownloadBoth">
                    <i class="bi bi-download"></i> Download Both
                </button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="bi bi-receipt"></i> Invoice @invoice.InvoiceNumber
                    <span class="badge bg-@GetStatusBadgeClass(invoice.Status) float-end">@invoice.Status</span>
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Invoice Details</h5>
                        <table class="table table-sm">
                            <tr>
                                <th>Invoice Number:</th>
                                <td>@invoice.InvoiceNumber</td>
                            </tr>
                            <tr>
                                <th>Type:</th>
                                <td>
                                    <span class="badge bg-@(invoice.Type == "Proforma" ? "info" : "success")">
                                        @invoice.Type
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>Invoice Date:</th>
                                <td>@invoice.InvoiceDate.ToString("dd/MM/yyyy")</td>
                            </tr>
                            <tr>
                                <th>Period:</th>
                                <td>@invoice.PeriodStart.ToString("dd/MM/yyyy") - @invoice.PeriodEnd.ToString("dd/MM/yyyy")</td>
                            </tr>
                            @if (invoice.SentDate.HasValue)
                            {
                                <tr>
                                    <th>Sent Date:</th>
                                    <td>@invoice.SentDate.Value.ToString("dd/MM/yyyy HH:mm")</td>
                                </tr>
                            }
                            @if (invoice.PaidDate.HasValue)
                            {
                                <tr>
                                    <th>Paid Date:</th>
                                    <td>@invoice.PaidDate.Value.ToString("dd/MM/yyyy HH:mm")</td>
                                </tr>
                            }
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Company Details</h5>
                        <table class="table table-sm">
                            <tr>
                                <th>Company:</th>
                                <td>@invoice.CompanyName</td>
                            </tr>
                        </table>

                        <h5 class="mt-4">Summary</h5>
                        <table class="table table-sm">
                            <tr>
                                <th>Total Trips:</th>
                                <td>@invoice.TripCount</td>
                            </tr>
                            <tr>
                                <th>Subtotal:</th>
                                <td>TZS @invoice.SubTotal.ToString("N2")</td>
                            </tr>
                            <tr>
                                <th>Tax:</th>
                                <td>TZS @invoice.TaxAmount.ToString("N2")</td>
                            </tr>
                            <tr class="table-primary">
                                <th><strong>Total Amount:</strong></th>
                                <td><strong>TZS @invoice.TotalAmount.ToString("N2")</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(invoice.Notes))
                {
                    <div class="mt-3">
                        <h5>Notes</h5>
                        <p>@invoice.Notes</p>
                    </div>
                }
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Trip Details (@invoice.Trips.Count trips)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Trip Name</th>
                                <th>Route</th>
                                <th>Vehicle</th>
                                <th>Driver</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th class="text-end">Base Price</th>
                                <th class="text-end">Tax</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < invoice.Trips.Count; i++)
                            {
                                var trip = invoice.Trips[i];
                                <tr>
                                    <td>@(i + 1)</td>
                                    <td>@trip.TripName</td>
                                    <td>
                                        <small>
                                            @(trip.FromLocationName ?? "N/A") <i class="bi bi-arrow-right"></i> @(trip.ToLocationName ?? "N/A")
                                        </small>
                                    </td>
                                    <td>@(trip.VehicleName ?? "N/A")</td>
                                    <td>@(trip.DriverName ?? "N/A")</td>
                                    <td>
                                        <small>@(trip.ActualEndTime?.ToString("dd/MM/yyyy") ?? trip.ScheduledStartTime.ToString("dd/MM/yyyy"))</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">@trip.Status</span>
                                    </td>
                                    <td class="text-end">@trip.BasePrice.ToString("N2")</td>
                                    <td class="text-end">@trip.TaxAmount.ToString("N2")</td>
                                    <td class="text-end"><strong>@trip.TotalPrice.ToString("N2")</strong></td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="7" class="text-end"><strong>Totals:</strong></td>
                                <td class="text-end"><strong>@invoice.SubTotal.ToString("N2")</strong></td>
                                <td class="text-end"><strong>@invoice.TaxAmount.ToString("N2")</strong></td>
                                <td class="text-end"><strong>@invoice.TotalAmount.ToString("N2")</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Invoice not found.
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private InvoiceDto? invoice;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoice();
    }

    private async Task LoadInvoice()
    {
        loading = true;
        try
        {
            invoice = await ApiService.GetInvoiceByIdAsync(Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading invoice: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/invoices");
    }

    private async Task MarkAsPaid()
    {
        try
        {
            await ApiService.MarkInvoiceAsPaidAsync(Id, new MarkInvoicePaidDto { PaidDate = DateTime.UtcNow });
            await LoadInvoice();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marking invoice as paid: {ex.Message}");
        }
    }

    private void DownloadPdf()
    {
        NavigationManager.NavigateTo($"/api/invoices/{Id}/download/pdf", true);
    }

    private void DownloadExcel()
    {
        NavigationManager.NavigateTo($"/api/invoices/{Id}/download/excel", true);
    }

    private void DownloadBoth()
    {
        NavigationManager.NavigateTo($"/api/invoices/{Id}/download/both", true);
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Draft" => "secondary",
            "Sent" => "info",
            "Paid" => "success",
            "Cancelled" => "danger",
            _ => "secondary"
        };
    }
}
