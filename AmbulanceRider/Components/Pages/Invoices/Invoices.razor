@page "/invoices"
@using AmbulanceRider.Models
@using AmbulanceRider.Services
@using AmbulanceRider.Components.Shared
@inject IApiService ApiService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin,Dispatcher")]

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0 w-50 justify-content-start"><i class="bi bi-receipt"></i> Invoices</h2>
        <div class="d-flex gap-2 w-50 justify-content-end">
            <button class="btn btn-primary" style="width: 50%" @onclick="NavigateToCreate">
                <i class="bi bi-plus-circle"></i> Create Invoice
            </button>
            <button class="btn btn-warning" @onclick="GenerateTestInvoices" title="Generate Test Invoices">
                <i class="bi bi-magic"></i> Generate Test Data
            </button>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Company</label>
                    <select class="form-select form-control" @bind="filterCompanyId">
                        <option value="">All Companies</option>
                        @foreach (var company in companies)
                        {
                            <option value="@company.Id">@company.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Type</label>
                    <select class="form-select form-control" @bind="filterType">
                        <option value="">All Types</option>
                        <option value="Proforma">Proforma</option>
                        <option value="Final">Final</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select form-control" @bind="filterStatus">
                        <option value="">All Status</option>
                        <option value="Draft">Draft</option>
                        <option value="Sent">Sent</option>
                        <option value="Paid">Paid</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" @bind="filterStartDate" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" @bind="filterEndDate" />
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" @onclick="LoadInvoices">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (invoices.Any())
    {
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Type</th>
                                <th>Company</th>
                                <th>Period</th>
                                <th>Trips</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoice in invoices)
                            {
                                <tr>
                                    <td><strong>@invoice.InvoiceNumber</strong></td>
                                    <td>
                                        <span class="badge bg-@(invoice.Type == "Proforma" ? "info" : "success")">
                                            @invoice.Type
                                        </span>
                                    </td>
                                    <td>@invoice.CompanyName</td>
                                    <td>
                                        <small>
                                            @invoice.PeriodStart.ToString("dd/MM/yyyy") - @invoice.PeriodEnd.ToString("dd/MM/yyyy")
                                        </small>
                                    </td>
                                    <td>@invoice.TripCount</td>
                                    <td><strong>TZS @invoice.TotalAmount.ToString("N2")</strong></td>
                                    <td>
                                        <span class="badge bg-@GetStatusBadgeClass(invoice.Status)">
                                            @invoice.Status
                                        </span>
                                    </td>
                                    <td>@invoice.InvoiceDate.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" @onclick="() => ViewInvoice(invoice.Id)" title="View">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            @if (invoice.Status != "Paid")
                                            {
                                                <button class="btn btn-outline-success" @onclick="() => MarkAsPaid(invoice.Id)" title="Mark as Paid">
                                                    <i class="bi bi-check-circle"></i>
                                                </button>
                                            }
                                            <button class="btn btn-outline-info" @onclick="() => SendInvoiceEmail(invoice.Id)" title="Send Email">
                                                <i class="bi bi-envelope"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" @onclick="() => DownloadPdf(invoice.Id)" title="Download PDF">
                                                <i class="bi bi-file-pdf"></i>
                                            </button>
                                            <button class="btn btn-outline-success" @onclick="() => DownloadExcel(invoice.Id)" title="Download Excel">
                                                <i class="bi bi-file-excel"></i>
                                            </button>
                                            <button class="btn btn-outline-info" @onclick="() => DownloadBoth(invoice.Id)" title="Download Both">
                                                <i class="bi bi-download"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No invoices found.
        </div>
    }
</div>

<EmailDialog @ref="emailDialog" OnSend="SendEmail" />

@code {
    private List<InvoiceDto> invoices = new();
    private List<CompanyDto> companies = new();
    private bool loading = true;

    private string filterCompanyId = "";
    private string filterType = "";
    private string filterStatus = "";
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;

    private EmailDialog emailDialog = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanies();
        await LoadInvoices();
    }

    private async Task LoadCompanies()
    {
        try
        {
            companies = await ApiService.GetCompaniesAsync() ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading companies: {ex.Message}");
        }
    }

    private async Task LoadInvoices()
    {
        loading = true;
        try
        {
            invoices = await ApiService.GetInvoicesAsync(new InvoiceFilterDto
            {
                CompanyId = string.IsNullOrEmpty(filterCompanyId) ? null : int.Parse(filterCompanyId),
                Type = string.IsNullOrEmpty(filterType) ? null : filterType,
                Status = string.IsNullOrEmpty(filterStatus) ? null : filterStatus,
                StartDate = filterStartDate,
                EndDate = filterEndDate
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading invoices: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private void NavigateToCreate()
    {
        NavigationManager.NavigateTo("/invoices/create");
    }

    private void ViewInvoice(int id)
    {
        NavigationManager.NavigateTo($"/invoices/{id}");
    }

    private async Task MarkAsPaid(int id)
    {
        try
        {
            await ApiService.MarkInvoiceAsPaidAsync(id, new MarkInvoicePaidDto { PaidDate = DateTime.UtcNow });
            await LoadInvoices();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marking invoice as paid: {ex.Message}");
        }
    }

    private async Task DownloadPdf(int id)
    {
        await DownloadFile($"invoices/{id}/download/pdf");
    }

    private async Task DownloadExcel(int id)
    {
        await DownloadFile($"invoices/{id}/download/excel");
    }

    private async Task DownloadBoth(int id)
    {
        await DownloadFile($"invoices/{id}/download/both");
    }

    private async Task DownloadFile(string endpoint)
    {
        try
        {
            var (bytes, contentType, fileName) = await ApiService.GetFileBytesAsync(endpoint);
            var base64 = Convert.ToBase64String(bytes);
            await JSRuntime.InvokeVoidAsync("downloadFileFromBytes", fileName, contentType, base64);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading file: {ex.Message}");
        }
    }

    private async Task SendEmail(bool success)
    {
        if (success)
        {
            await LoadInvoices();
        }
    }

    private void ShowEmailDialog(int id, string invoiceNumber, string companyName, string invoiceType)
    {
        var invoice = invoices.FirstOrDefault(i => i.Id == id);
        if (invoice != null)
        {
            emailDialog.InvoiceId = id;
            emailDialog.DefaultSubject = $"{invoiceType} Invoice {invoiceNumber} - {companyName}";
            emailDialog.DefaultBody = $"Dear {companyName},\n\nPlease find attached your {invoiceType} invoice {invoiceNumber}.\n\nBest regards,\nAmbulanceRider Team";
            
            var company = companies.FirstOrDefault(c => c.Id == invoice.CompanyId);
            emailDialog.CompanyContactEmail = company?.ContactEmail ?? "";
            
            emailDialog.OnSend = EventCallback.Factory.Create<bool>(this, async (success) => 
            {
                if (success)
                {
                    await LoadInvoices();
                }
            });
            
            emailDialog.Show = true;
        }
    }

    private async Task SendInvoiceEmail(int id)
    {
        var invoice = invoices.FirstOrDefault(i => i.Id == id);
        if (invoice != null)
        {
            ShowEmailDialog(id, invoice.InvoiceNumber, invoice.CompanyName, invoice.Type);
        }
    }

    private async Task GenerateTestInvoices()
    {
        try
        {
            await ApiService.PostAsync<InvoiceDto>("invoices/generate-test-invoices", new { count = 5 });
            await LoadInvoices();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error generating test invoices: {ex.Message}");
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Draft" => "secondary",
            "Sent" => "info",
            "Paid" => "success",
            "Cancelled" => "danger",
            _ => "secondary"
        };
    }
}
