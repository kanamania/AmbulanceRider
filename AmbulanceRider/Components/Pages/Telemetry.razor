@page "/telemetry"
@using AmbulanceRider.Models
@using AmbulanceRider.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin,Dispatcher")]
@inject ITelemetryService TelemetryService
@inject NavigationManager Navigation

<PageTitle>Telemetry Dashboard</PageTitle>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-graph-up me-2"></i>Telemetry Dashboard
        </h1>
        <div class="d-flex gap-2">
            <div style="display: flex;">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                    <input type="date" class="form-control" @bind="_startDate" @bind:format="yyyy-MM-dd"/>
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" @bind="_endDate" @bind:format="yyyy-MM-dd"/>
                </div>
                <button class="btn btn-primary" style="width: 80px;border-top-left-radius: 0;border-bottom-left-radius: 0;" @onclick="LoadData">
                    <i class="bi bi-funnel"></i>
                </button>
            </div>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading telemetry data...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@_errorMessage
        </div>
    }
    else
    {
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Total Events</h6>
                                <h3 class="mb-0">@_summary?.TotalEvents.ToString("N0")</h3>
                            </div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded">
                                <i class="bi bi-activity text-primary fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Unique Users</h6>
                                <h3 class="mb-0">@_summary?.UniqueUsers.ToString("N0")</h3>
                            </div>
                            <div class="bg-success bg-opacity-10 p-3 rounded">
                                <i class="bi bi-people text-success fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Unique Devices</h6>
                                <h3 class="mb-0">@_summary?.UniqueDevices.ToString("N0")</h3>
                            </div>
                            <div class="bg-warning bg-opacity-10 p-3 rounded">
                                <i class="bi bi-phone text-warning fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Time Range</h6>
                                <h6 class="mb-0">
                                    @(_summary?.FirstEventDate?.ToString("MMM d, yyyy") ?? "N/A")
                                    <span class="mx-1">-</span>
                                    @(_summary?.LastEventDate?.ToString("MMM d, yyyy") ?? "N/A")
                                </h6>
                            </div>
                            <div class="bg-info bg-opacity-10 p-3 rounded">
                                <i class="bi bi-calendar-range text-info fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0">Event Types</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="eventTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0">Device Types</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="deviceTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event Log -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Event Log</h5>
                <div class="d-flex gap-2">
                    <input type="text" class="form-control" placeholder="Search events..." @bind="_searchQuery" @bind:event="oninput" />
                    <select class="form-select" style="width: 200px;" @bind="_selectedEventType">
                        <option value="">All Event Types</option>
                        @foreach (var eventType in _eventTypes)
                        {
                            <option value="@eventType">@eventType</option>
                        }
                    </select>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Timestamp</th>
                            <th>Event Type</th>
                            <th>User</th>
                            <th>Device</th>
                            <th>Browser</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (_events.Any())
                        {
                            foreach (var evt in _filteredEvents)
                            {
                                <tr>
                                    <td>@evt.Timestamp.ToString("g")</td>
                                    <td><span class="badge bg-primary">@evt.EventType</span></td>
                                    <td>@(string.IsNullOrEmpty(evt.UserName) ? "Anonymous" : evt.UserName)</td>
                                    <td>@(string.IsNullOrEmpty(evt.DeviceType) ? "-" : evt.DeviceType)</td>
                                    <td>@(string.IsNullOrEmpty(evt.Browser) ? "-" : evt.Browser)</td>
                                    <td>
                                        @if (evt.Latitude.HasValue && evt.Longitude.HasValue)
                                        {
                                            <a href="#" @onclick="() => ShowMap(evt.Latitude.Value, evt.Longitude.Value)">
                                                <i class="bi bi-geo-alt"></i> View
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    No telemetry events found
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="card-footer bg-white border-top d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    Showing @_filteredEvents.Count of @_events.Count events
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm" @onclick="PreviousPage" disabled="@(_currentPage <= 1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" disabled>Page @_currentPage</button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick="NextPage" disabled="@(_currentPage * _pageSize >= _events.Count)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<!-- Map Modal -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" style="height: 500px;">
                <div id="map" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>
</div>

@inject IJSRuntime JSRuntime

@code {
    private IJSObjectReference? _module;
    private TelemetrySummaryDto _summary = new();
    private List<TelemetryEventDto> _events = new();
    private List<TelemetryEventDto> _filteredEvents = new();
    private List<string> _eventTypes = new();
    private bool _isLoading = true;
    private string _errorMessage = string.Empty;
    private DateTime? _startDate = DateTime.Today.AddDays(-30);
    private DateTime? _endDate = DateTime.Today;
    private string _searchQuery = string.Empty;
    private string _selectedEventType = string.Empty;
    private int _currentPage = 1;
    private int _pageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/telemetry.js");
        }
        
        if (!_isLoading && _summary != null)
        {
            await RenderCharts();
        }
    }

    private async Task LoadData()
    {
        try
        {
            _isLoading = true;
            _errorMessage = string.Empty;
            StateHasChanged();

            // Load summary data
            _summary = await TelemetryService.GetSummaryAsync(_startDate, _endDate);
            
            // Load events
            _events = await TelemetryService.GetEventsAsync(1, 1000, null, null, _startDate, _endDate);
            _filteredEvents = _events.Take(_pageSize).ToList();
            
            // Extract unique event types for filter
            _eventTypes = _events.Select(e => e.EventType)
                               .Distinct()
                               .OrderBy(e => e)
                               .ToList();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading telemetry data: {ex.Message}";
            Console.Error.WriteLine(ex);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RenderCharts()
    {
        if (_module != null)
        {
            // Render event type chart
            var eventTypeData = _summary.EventsByType
                .OrderByDescending(x => x.Value)
                .ToDictionary(x => x.Key, x => x.Value);

            await _module.InvokeVoidAsync("renderPieChart", 
                "eventTypeChart", 
                "Event Type Distribution", 
                eventTypeData.Keys.ToList(), 
                eventTypeData.Values.ToList()
            );

            // Render device type chart
            var deviceTypeData = _summary.EventsByDeviceType
                .OrderByDescending(x => x.Value)
                .ToDictionary(x => x.Key, x => x.Value);

            await _module.InvokeVoidAsync("renderBarChart", 
                "deviceTypeChart", 
                "Device Type Distribution", 
                deviceTypeData.Keys.ToList(), 
                deviceTypeData.Values.ToList()
            );
        }
    }

    private void ApplyFilters()
    {
        _filteredEvents = _events
            .Where(e => string.IsNullOrEmpty(_searchQuery) || 
                       (e.EventType?.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) == true) ||
                       (e.UserName?.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) == true) ||
                       (e.DeviceType?.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) == true) ||
                       (e.Browser?.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) == true))
            .Where(e => string.IsNullOrEmpty(_selectedEventType) || e.EventType == _selectedEventType)
            .Skip((_currentPage - 1) * _pageSize)
            .Take(_pageSize)
            .ToList();
    }

    private void NextPage()
    {
        _currentPage++;
        ApplyFilters();
    }

    private void PreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            ApplyFilters();
        }
    }

    private async Task ShowMap(double latitude, double longitude)
    {
        if (_module != null)
        {
            await _module.InvokeVoidAsync("showMap", latitude, longitude);
            
            // Create and show the modal using JavaScript
            await JSRuntime.InvokeVoidAsync(@"(function() {
                var modal = new bootstrap.Modal(document.getElementById('mapModal'));
                modal.show();
            })");
        }
    }

    public void Dispose()
    {
        _module?.DisposeAsync();
    }
}
