@page "/locations/create"
@using AmbulanceRider.Models
@using AmbulanceRider.Services
@using AmbulanceRider.Components.Shared
@inject ApiService ApiService
@inject NavigationManager Navigation

<PageTitle>Create Location</PageTitle>

<div class="container-fluid">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-outline-secondary me-3" @onclick="GoBack">
            <i class="bi bi-arrow-left"></i>
        </button>
        <h1><i class="bi bi-geo-alt me-2"></i>Create New Location</h1>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <EditForm Model="createLocationDto" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-tag me-1"></i>Location Name
                            </label>
                            <InputText class="form-control form-control-lg" @bind-Value="createLocationDto.Name" placeholder="Enter location name" />
                            <ValidationMessage For="@(() => createLocationDto.Name)" class="text-danger" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-map me-1"></i>Select Location on Map
                            </label>
                            <MapPicker 
                                MapId="create-location-map"
                                Latitude="@createLocationDto.Latitude"
                                Longitude="@createLocationDto.Longitude"
                                Zoom="13"
                                Editable="true"
                                Height="500px"
                                OnLocationChanged="HandleLocationChanged" />
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-outline-secondary" @onclick="GoBack">
                                <i class="bi bi-x-circle me-1"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Creating...</span>
                                }
                                else
                                {
                                    <i class="bi bi-check-circle me-1"></i>
                                    <span>Create Location</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Location Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Name:</strong>
                        <p class="text-muted mb-0">@(string.IsNullOrEmpty(createLocationDto.Name) ? "Not set" : createLocationDto.Name)</p>
                    </div>
                    <div class="mb-3">
                        <strong>Latitude:</strong>
                        <p class="text-muted mb-0">@createLocationDto.Latitude.ToString("F6")</p>
                    </div>
                    <div class="mb-3">
                        <strong>Longitude:</strong>
                        <p class="text-muted mb-0">@createLocationDto.Longitude.ToString("F6")</p>
                    </div>
                    <hr />
                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="bi bi-lightbulb me-1"></i>
                            <strong>Tip:</strong> Click on the map or drag the marker to set the exact location. You can also enter coordinates manually.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private CreateLocationDto createLocationDto = new() 
    { 
        Latitude = -6.812647380814953,  // Default to Nairobi
        Longitude = 39.276215266217456
    };
    private bool isSubmitting = false;
    private string? errorMessage;

    private void HandleLocationChanged((double Latitude, double Longitude) location)
    {
        createLocationDto.Latitude = location.Latitude;
        createLocationDto.Longitude = location.Longitude;
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSubmitting = true;
            errorMessage = null;

            if (string.IsNullOrWhiteSpace(createLocationDto.Name))
            {
                errorMessage = "Location name is required";
                return;
            }

            if (createLocationDto.Latitude == 0 && createLocationDto.Longitude == 0)
            {
                errorMessage = "Please select a location on the map";
                return;
            }

            await ApiService.CreateLocationAsync(createLocationDto);
            Navigation.NavigateTo("/locations");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating location: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/locations");
    }
}
