@using AmbulanceRider.Models
@using AmbulanceRider.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject ApiService ApiService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject TelemetryService TelemetryService

@if (Trip != null)
{
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Trip Actions</h5>
        </div>
        <div class="card-body">
            @if (IsDriverOrUser)
            {
                <div class="mb-3">
                    <h6>Complete or Cancel Trip</h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" @onclick="() => ShowCompleteModal = true" 
                                disabled="@(Trip.Status != "InProgress")">
                            <i class="bi bi-check-circle me-1"></i>Complete Trip
                        </button>
                        <button class="btn btn-danger" @onclick="() => ShowCancelModal = true"
                                disabled="@(Trip.Status == "Completed" || Trip.Status == "Cancelled")">
                            <i class="bi bi-x-circle me-1"></i>Cancel Trip
                        </button>
                    </div>
                </div>
            }

            @if (IsAdminOrDispatcher)
            {
                <div class="border-top pt-3 mt-3">
                    <h6>Admin Actions</h6>
                    @if (Trip.Status == "Pending")
                    {
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" @onclick="() => ShowApproveModal = true">
                                <i class="bi bi-check-circle me-1"></i>Approve
                            </button>
                            <button class="btn btn-danger" @onclick="() => ShowRejectModal = true">
                                <i class="bi bi-x-circle me-1"></i>Reject
                            </button>
                        </div>
                    }
                    @if (Trip.Status == "InProgress")
                    {
                        <button class="btn btn-warning" @onclick="ForceCompleteTrip">
                            <i class="bi bi-exclamation-triangle me-1"></i>Force Complete
                        </button>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Complete Trip Modal -->
    <div class="modal @(ShowCompleteModal ? "d-block" : "d-none")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Trip</h5>
                    <button type="button" class="btn-close" @onclick="() => { ShowCompleteModal = false; Notes = string.Empty; }"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" @bind="Notes" rows="3" placeholder="Add any notes about the trip completion"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => { ShowCompleteModal = false; Notes = string.Empty; }">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="CompleteTrip">Complete Trip</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Trip Modal -->
    <div class="modal @(ShowCancelModal ? "d-block" : "d-none")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cancel Trip</h5>
                    <button type="button" class="btn-close" @onclick="() => { ShowCancelModal = false; Notes = string.Empty; }"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Reason (Optional)</label>
                        <textarea class="form-control" @bind="Notes" rows="3" placeholder="Please provide a reason for cancellation"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => { ShowCancelModal = false; Notes = string.Empty; }">Close</button>
                    <button type="button" class="btn btn-danger" @onclick="CancelTrip">Confirm Cancellation</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approve Trip Modal -->
    <div class="modal @(ShowApproveModal ? "d-block" : "d-none")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Approve Trip</h5>
                    <button type="button" class="btn-close" @onclick="() => { ShowApproveModal = false; Notes = string.Empty; }"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" @bind="Notes" rows="3" placeholder="Add any notes about the approval"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => { ShowApproveModal = false; Notes = string.Empty; }">Cancel</button>
                    <button type="button" class="btn btn-success" @onclick="ApproveTrip">Approve Trip</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Trip Modal -->
    <div class="modal @(ShowRejectModal ? "d-block" : "d-none")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reject Trip</h5>
                    <button type="button" class="btn-close" @onclick="() => { ShowRejectModal = false; Notes = string.Empty; }"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Reason for Rejection *</label>
                        <textarea class="form-control" @bind="Notes" rows="3" placeholder="Please provide a reason for rejection" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => { ShowRejectModal = false; Notes = string.Empty; }">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="RejectTrip" disabled="@string.IsNullOrWhiteSpace(Notes)">
                        Reject Trip
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public TripDto? Trip { get; set; }

    [Parameter]
    public EventCallback<TripDto> OnTripUpdated { get; set; }

    private bool IsAdminOrDispatcher { get; set; }
    private bool IsDriverOrUser { get; set; }
    private string Notes { get; set; } = string.Empty;
    private bool ShowCompleteModal { get; set; }
    private bool ShowCancelModal { get; set; }
    private bool ShowApproveModal { get; set; }
    private bool ShowRejectModal { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await CheckUserRoles();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Trip != null)
        {
            await CheckUserRoles();
        }
    }

    private async Task CheckUserRoles()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        IsAdminOrDispatcher = user.IsInRole("Admin") || user.IsInRole("Dispatcher");
        
        // Check if current user is the driver
        var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        IsDriverOrUser = Trip?.DriverId?.ToString() == userId;
    }

    private async Task CompleteTrip()
    {
        try
        {
            var updateDto = new UpdateTripStatusDto
            {
                Id = Trip!.Id,
                Status = TripStatus.Completed,
                Notes = Notes,
                Telemetry = await TelemetryService.CollectTelemetryAsync()
            };

            var result = await ApiService.UpdateTripStatusAsync(Trip.Id, updateDto);
            if (result != null)
            {
                await OnTripUpdated.InvokeAsync(result);
                ShowCompleteModal = false;
                Notes = string.Empty;
            }
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error completing trip: {ex.Message}");
        }
    }

    private async Task CancelTrip()
    {
        try
        {
            var updateDto = new UpdateTripStatusDto
            {
                Id = Trip!.Id,
                Status = TripStatus.Cancelled,
                Notes = Notes,
                Telemetry = await TelemetryService.CollectTelemetryAsync()
            };

            var result = await ApiService.UpdateTripStatusAsync(Trip.Id, updateDto);
            if (result != null)
            {
                await OnTripUpdated.InvokeAsync(result);
                ShowCancelModal = false;
                Notes = string.Empty;
            }
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error cancelling trip: {ex.Message}");
        }
    }

    private async Task ApproveTrip()
    {
        try
        {
            var updateDto = new UpdateTripStatusDto
            {
                Id = Trip!.Id,
                Status = TripStatus.Approved,
                Notes = Notes,
                Telemetry = await TelemetryService.CollectTelemetryAsync()
            };

            var result = await ApiService.UpdateTripStatusAsync(Trip.Id, updateDto);
            if (result != null)
            {
                await OnTripUpdated.InvokeAsync(result);
                ShowApproveModal = false;
                Notes = string.Empty;
            }
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error approving trip: {ex.Message}");
        }
    }

    private async Task RejectTrip()
    {
        if (string.IsNullOrWhiteSpace(Notes))
            return;

        try
        {
            var updateDto = new UpdateTripStatusDto
            {
                Id = Trip!.Id,
                Status = TripStatus.Rejected,
                Notes = Notes,
                RejectionReason = Notes,
                Telemetry = await TelemetryService.CollectTelemetryAsync()
            };

            var result = await ApiService.UpdateTripStatusAsync(Trip.Id, updateDto);
            if (result != null)
            {
                await OnTripUpdated.InvokeAsync(result);
                ShowRejectModal = false;
                Notes = string.Empty;
            }
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error rejecting trip: {ex.Message}");
        }
    }

    private async Task ForceCompleteTrip()
    {
        try
        {
            var updateDto = new UpdateTripStatusDto
            {
                Id = Trip!.Id,
                Status = TripStatus.Completed,
                Notes = "Trip was force completed by admin/dispatcher.",
                ForceComplete = true,
                Telemetry = await TelemetryService.CollectTelemetryAsync()
            };

            var result = await ApiService.UpdateTripStatusAsync(Trip.Id, updateDto);
            if (result != null)
            {
                await OnTripUpdated.InvokeAsync(result);
            }
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error force completing trip: {ex.Message}");
        }
    }
}
